syntax = "proto3";

package com.pulsehub.datasync;

option java_package = "com.pulsehub.datasync.proto";
option java_multiple_files = true;

import "google/protobuf/any.proto";
import "google/protobuf/timestamp.proto";

/**
 * Enhanced UserProfile Sync Event for DocSyncProducer
 * 
 * Supports hybrid sync strategy:
 * - IMMEDIATE sync for critical business data (status, permissions, vip_level)
 * - BATCH sync for behavioral data and statistics
 * 
 * Features:
 * - Version control for consistency
 * - Incremental updates based on UserProfileDocument structure
 * - Type-safe cross-service communication via protobuf
 */
message UserProfileSyncEvent {
    // 基础信息
    string user_id = 1;
    SyncPriority priority = 2;  // 区分立即同步和批量同步
    SyncType sync_type = 3;     // 区分全量和增量更新
    int64 version = 4;          // 版本控制
    google.protobuf.Timestamp timestamp = 5;
    
    // 核心字段更新
    ProfileMetadata metadata = 6;
    
    // 数据分区更新 - 增量同步到MongoDB (基于UserProfileDocument结构)
    map<string, google.protobuf.Any> static_profile_updates = 10;
    map<string, google.protobuf.Any> dynamic_profile_updates = 11;
    map<string, google.protobuf.Any> computed_metrics_updates = 12;
    map<string, google.protobuf.Any> social_media_updates = 13;
    map<string, google.protobuf.Any> interests_preferences_updates = 14;
    map<string, google.protobuf.Any> professional_info_updates = 15;
    map<string, google.protobuf.Any> behavioral_data_updates = 16;
    map<string, google.protobuf.Any> extended_properties_updates = 17;
    
    // 特殊字段
    repeated string tags_to_add = 20;
    repeated string tags_to_remove = 21;
    string status_update = 22;
}

/**
 * Profile metadata information
 */
message ProfileMetadata {
    google.protobuf.Timestamp registration_date = 1;
    google.protobuf.Timestamp last_active_at = 2;
    google.protobuf.Timestamp
        lastUpdated = 3;  //profile数据更新时间
}

/**
 * Sync priority enumeration
 * Distinguishes between immediate sync and batch sync
 */
enum SyncPriority {
    IMMEDIATE = 0;    // 关键业务数据，立即同步
    BATCH = 1;        // 普通数据，批量同步
}

/**
 * Sync type enumeration
 * Distinguishes between full sync and incremental sync
 */
enum SyncType {
    FULL_SYNC = 0;        // 全量更新 - 完整用户画像同步
    INCREMENTAL_SYNC = 1; // 增量更新 - 只同步变更字段
}